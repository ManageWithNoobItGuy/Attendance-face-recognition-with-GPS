<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.js"></script>
  <style>
    body { font-family: 'Sarabun', sans-serif; text-align: center; padding: 20px; background-color: #f0f2f5; }
    
    .video-container { position: relative; width: 100%; max-width: 600px; margin: 20px auto; border-radius: 12px; overflow: hidden; background: #000; min-height: 350px; }
    video { width: 100%; height: auto; display: block; transform: scaleX(-1); }
    
    #overlay-status { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 20px; border-radius: 30px; z-index: 10; white-space: nowrap; }
    
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; }
    
    .btn { border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; margin: 5px; width: 100px; color: white; font-size: 16px; }
    .btn-confirm { background: #28a745; } 
    .btn-cancel { background: #dc3545; }
    
    .user-name { font-size: 24px; color: #007bff; font-weight: bold; margin: 10px 0; }
    .score-text { color:#666; font-size:14px; margin-bottom:20px; }
  </style>
</head>
<body>
  <h2>üì∑ ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</h2>
  <div id="main-status">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏∞‡∏ö‡∏ö...</div>

  <div class="video-container">
    <div id="overlay-status">‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î...</div>
    <video id="video" autoplay muted playsinline></video>
  </div>
  
  <? var url = getScriptUrl(); ?>
  <a href="<?= url ?>" style="margin-top:20px; display:inline-block; text-decoration:none; color:#555;">‚Üê ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å / ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>

  <div id="confirmModal" class="modal-overlay">
    <div class="modal-content">
      <h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h3>
      <div class="user-name" id="modalName">...</div>
      <div id="modalScore" class="score-text"></div>
      
      <button class="btn btn-confirm" onclick="confirmAttendance()">‚úÖ ‡πÉ‡∏ä‡πà</button>
      <button class="btn btn-cancel" onclick="cancelAttendance()">‚ùå ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà</button>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const mainStatus = document.getElementById('main-status');
    const overlayStatus = document.getElementById('overlay-status');
    const confirmModal = document.getElementById('confirmModal');
    
    // ‡∏£‡∏±‡∏ö URL ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏£‡∏≤‡∏°‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ JS
    const MAIN_MENU_URL = "<?= url ?>"; 

    let knownFaces = [];
    let scanInterval = null;
    let currentMatch = null;

    // ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ (0.45 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏°‡∏∏‡∏°, 0.6 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)
    const MATCH_THRESHOLD = 0.45; 

    window.addEventListener('load', async () => {
      try {
        if(typeof faceapi === 'undefined') throw new Error("Library Load Failed");
        
        mainStatus.innerText = "1/3 Loading AI...";
        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
        await Promise.all([
          faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
          faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
          faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ]);
        
        loadFaceData();
      } catch(e) { showError(e.message); }
    });

    function loadFaceData() {
      mainStatus.innerText = "2/3 Loading Database...";
      google.script.run.withSuccessHandler(data => {
        if(!data || data.length === 0) return showError("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô");
        
        knownFaces = data.map(u => ({
          name: u.label,
          descriptor: new Float32Array(u.descriptor)
        }));
        
        mainStatus.innerText = "3/3 Starting Camera...";
        startVideo();
      }).getKnownFaces();
    }

    function startVideo() {
      navigator.mediaDevices.getUserMedia({ video: {} }).then(stream => {
        video.srcObject = stream;
        mainStatus.innerText = "‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
        mainStatus.style.color = "green";
        startScanningLoop();
      });
    }

    function startScanningLoop() {
      if (scanInterval) clearInterval(scanInterval);
      overlayStatus.innerText = "‡∏°‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô";
      overlayStatus.style.background = "rgba(0,0,0,0.7)";
      
      scanInterval = setInterval(async () => {
        if (video.paused || video.ended) return;
        
        const detection = await faceapi.detectSingleFace(video).withFaceLandmarks().withFaceDescriptor();
        
        if (detection) {
          const bestMatch = findBestMatch(detection.descriptor);
          
          if (bestMatch.distance < MATCH_THRESHOLD) {
            clearInterval(scanInterval); // ‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô
            showModal(bestMatch);
          } else {
            overlayStatus.innerText = `‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å (${bestMatch.distance.toFixed(2)})`;
            overlayStatus.style.background = "rgba(200, 0, 0, 0.7)";
          }
        }
      }, 500);
    }

    function findBestMatch(queryDescriptor) {
      let bestMatch = { name: 'unknown', distance: 1.0 };
      knownFaces.forEach(user => {
        const distance = faceapi.euclideanDistance(queryDescriptor, user.descriptor);
        if (distance < bestMatch.distance) {
          bestMatch = { name: user.name, distance: distance };
        }
      });
      return bestMatch;
    }

    function showModal(match) {
      currentMatch = match.name;
      document.getElementById('modalName').innerText = match.name;
      document.getElementById('modalScore').innerText = `‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô: ${(1-match.distance).toFixed(2)*100}%`;
      confirmModal.style.display = "flex";
      mainStatus.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô...";
    }

    // --- ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å ---
    function confirmAttendance() {
      const btn = document.querySelector('.btn-confirm');
      btn.disabled = true;
      btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
      
      google.script.run.withSuccessHandler(() => {
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        
        // ‡∏™‡∏±‡πà‡∏á Redirect ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Main Menu
        window.top.location.href = MAIN_MENU_URL;
        
      }).logAttendance(currentMatch);
    }

    function cancelAttendance() {
      confirmModal.style.display = "none";
      currentMatch = null;
      mainStatus.innerText = "‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
      startScanningLoop();
    }

    function showError(msg) { mainStatus.innerHTML = `<span style='color:red'>‚ùå ${msg}</span>`; }
  </script>
</body>
</html>
